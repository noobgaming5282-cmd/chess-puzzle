<div style="text-align: center; margin: 30px 0;">
    <div id="chess-game-container" style="max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); border: 2px solid #3498db;">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">‚ôû Chess Puzzle Racer</h2>
        
        <div style="display: flex; justify-content: space-between; margin: 25px 0; font-size: 22px; font-weight: bold;">
            <div id="game-timer" style="color: #e74c3c;">‚è∞ Time: 60s</div>
            <div id="game-score" style="color: #27ae60;">üèÜ Score: 0</div>
        </div>
        
        <div id="chess-board" style="width: 400px; height: 400px; margin: 0 auto; border: 2px solid #b58863;"></div>
        
        <div style="margin: 25px 0;">
            <button id="game-start-btn" style="padding: 15px 40px; font-size: 18px; background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">üéÆ Start Game</button>
        </div>
        
        <p style="color: #7f8c8d; font-size: 14px; line-height: 1.5;">
            <strong>How to play:</strong> Solve chess puzzles before time runs out!<br>
            Drag and drop pieces to make the correct move. Each correct move = 10 points.
        </p>
    </div>
</div>

<!-- Load Chess Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

<script>
// Wait for all libraries to load
window.addEventListener('load', function() {
    console.log('Page loaded, initializing chess game...');
    
    // Initialize chess game
    const game = new Chess();
    let board = null;
    let timeLeft = 60;
    let score = 0;
    let timer = null;
    let currentPuzzle = null;
    let gameActive = false;

    // Chess puzzles database
    const puzzles = [
        {
            fen: 'r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 2 3',
            solution: ['f3g5'], // Knight takes pawn
            description: "Fork the king and queen"
        },
        {
            fen: 'rnbqkbnr/pppp1ppp/8/4p3/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 2',
            solution: ['d8h4'], // Queen to h4 check
            description: "Deliver checkmate"
        },
        {
            fen: 'rnbqkbnr/ppp2ppp/3p4/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 3',
            solution: ['f3e5'], // Knight takes pawn
            description: "Win material"
        }
    ];

    // Initialize the chessboard
    function initChessboard() {
        console.log('Initializing chessboard...');
        board = Chessboard('chess-board', {
            position: 'start',
            draggable: true,
            onDrop: handleMove,
            pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png',
            showErrors: true
        });
        
        // Test if board initialized
        if (board) {
            console.log('Chessboard initialized successfully!');
        } else {
            console.error('Chessboard failed to initialize');
        }
    }

    // Start game function
    function startGame() {
        console.log('Start game clicked');
        
        if (gameActive) {
            console.log('Game already active');
            return;
        }
        
        gameActive = true;
        timeLeft = 60;
        score = 0;
        updateDisplay();
        
        const startBtn = document.getElementById('game-start-btn');
        startBtn.textContent = 'Game Running...';
        startBtn.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
        startBtn.disabled = true;
        
        // Clear any existing timer
        if (timer) {
            clearInterval(timer);
        }
        
        // Start countdown timer
        timer = setInterval(() => {
            timeLeft--;
            updateDisplay();
            
            if (timeLeft <= 0) {
                endGame();
            }
        }, 1000);

        // Load first puzzle
        loadNewPuzzle();
    }

    // Load a new puzzle
    function loadNewPuzzle() {
        if (!puzzles.length) return;
        
        // Select random puzzle
        const randomIndex = Math.floor(Math.random() * puzzles.length);
        currentPuzzle = puzzles[randomIndex];
        
        console.log('Loading puzzle:', currentPuzzle.fen);
        
        // Load position into chess.js
        game.load(currentPuzzle.fen);
        
        // Update board display
        if (board) {
            board.position(currentPuzzle.fen);
        }
    }

    // Handle piece moves
    function handleMove(source, target) {
        console.log('Move attempted:', source, 'to', target);
        
        if (!gameActive) {
            console.log('Game not active - snapping back');
            return 'snapback';
        }
        
        // Make the move in chess.js
        const move = game.move({
            from: source,
            to: target,
            promotion: 'q' // Always promote to queen for simplicity
        });

        // Illegal move
        if (move === null) {
            console.log('Illegal move - snapping back');
            return 'snapback';
        }

        console.log('Legal move made:', move.san);
        
        // Check if this is the correct puzzle solution
        const moveStr = move.from + move.to;
        if (currentPuzzle.solution.includes(moveStr)) {
            console.log('Correct move!');
            score += 10;
            updateDisplay();
            
            // Load next puzzle after short delay
            setTimeout(() => {
                loadNewPuzzle();
            }, 800);
        } else {
            console.log('Incorrect move');
            // For now, we just allow any legal move
            // You can add penalty logic here if needed
        }
        
        return true;
    }

    // Update display
    function updateDisplay() {
        document.getElementById('game-timer').textContent = `‚è∞ Time: ${timeLeft}s`;
        document.getElementById('game-score').textContent = `üèÜ Score: ${score}`;
    }

    // End game
    function endGame() {
        console.log('Game ended');
        gameActive = false;
        
        if (timer) {
            clearInterval(timer);
            timer = null;
        }
        
        const startBtn = document.getElementById('game-start-btn');
        startBtn.textContent = 'üéÆ Play Again';
        startBtn.style.background = 'linear-gradient(135deg, #27ae60, #229954)';
        startBtn.disabled = false;
        
        // Show game over message
        setTimeout(() => {
            alert(`üéØ Game Over!\n\nYour final score: ${score}\n\nGreat job! Click "Play Again" to restart.`);
        }, 100);
        
        // Reset board to starting position
        game.reset();
        if (board) {
            board.position('start');
        }
    }

    // Initialize everything when page is ready
    function initializeGame() {
        console.log('Initializing game...');
        
        // Initialize chessboard first
        initChessboard();
        
        // Add event listener to start button
        const startBtn = document.getElementById('game-start-btn');
        if (startBtn) {
            startBtn.addEventListener('click', startGame);
            console.log('Start button event listener added');
        } else {
            console.error('Start button not found!');
        }
        
        console.log('Game initialization complete');
    }

    // Start initialization
    initializeGame();
});
</script>
