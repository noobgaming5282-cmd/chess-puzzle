<!DOCTYPE html>
<html>
<head>
    <title>Chess Puzzle Racer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
        }
        #chess-puzzle-racer {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }
        #timer, #score {
            font-size: 24px;
            margin: 15px 0;
            color: #333;
        }
        #board {
            width: 400px;
            margin: 0 auto;
        }
        #controls {
            margin: 20px 0;
        }
        #startBtn {
            padding: 12px 30px;
            font-size: 18px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #startBtn:hover {
            background: #218838;
        }
        @media (max-width: 480px) {
            #board {
                width: 300px;
            }
            #timer, #score {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div id="chess-puzzle-racer">
        <h2>Chess Puzzle Racer</h2>
        <div id="timer">Time: 60s</div>
        <div id="score">Score: 0</div>
        <div id="board"></div>
        <div id="controls">
            <button id="startBtn">Start Game</button>
        </div>
        <p>Solve chess puzzles as fast as you can!</p>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    
    <script>
    class PuzzleRacer {
        constructor() {
            this.board = null;
            this.game = new Chess();
            this.timeLeft = 60;
            this.score = 0;
            this.timer = null;
            this.currentPuzzle = null;
            
            this.init();
        }

        init() {
            this.board = Chessboard('board', {
                position: 'start',
                draggable: true,
                onDrop: this.handleMove.bind(this),
                pieceTheme: 'https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/img/chesspieces/wikipedia/{piece}.png'
            });

            document.getElementById('startBtn').addEventListener('click', () => {
                this.startGame();
            });
        }

        async startGame() {
            // Reset game state
            this.timeLeft = 60;
            this.score = 0;
            this.updateDisplay();
            
            // Clear existing timer
            if (this.timer) {
                clearInterval(this.timer);
            }
            
            // Start countdown
            this.timer = setInterval(() => {
                this.timeLeft--;
                this.updateDisplay();
                
                if (this.timeLeft <= 0) {
                    this.endGame();
                }
            }, 1000);

            await this.loadNewPuzzle();
        }

        async loadNewPuzzle() {
            try {
                // Try to get a puzzle from Lichess API
                const response = await fetch('https://lichess.org/api/puzzle/daily');
                const puzzle = await response.json();
                this.currentPuzzle = puzzle;
                
                this.game.load(puzzle.fen);
                this.board.position(puzzle.fen);
                
            } catch (error) {
                console.error('Error loading puzzle from Lichess, using local puzzle:', error);
                this.loadLocalPuzzle();
            }
        }

        loadLocalPuzzle() {
            // Local fallback puzzles
            const puzzles = [
                {
                    fen: 'r1bqkbnr/pppp1ppp/2n5/4p3/4P3/5N2/PPPP1PPP/RNBQKB1R w KQkq - 0 1',
                    solution: ['f3g5']
                },
                {
                    fen: 'rnbqkbnr/pppp1ppp/8/4p3/6P1/5P2/PPPPP2P/RNBQKBNR b KQkq - 0 1',
                    solution: ['d8h4']
                }
            ];
            
            this.currentPuzzle = puzzles[Math.floor(Math.random() * puzzles.length)];
            this.game.load(this.currentPuzzle.fen);
            this.board.position(this.currentPuzzle.fen);
        }

        handleMove(source, target) {
            const move = this.game.move({
                from: source,
                to: target,
                promotion: 'q'
            });

            // Illegal move
            if (move === null) return 'snapback';

            // Check if correct move
            if (this.isCorrectMove(move)) {
                this.score += 10;
                this.updateDisplay();
                setTimeout(() => this.loadNewPuzzle(), 500);
            }
        }

        isCorrectMove(move) {
            const moveStr = move.from + move.to;
            return this.currentPuzzle.solution.includes(moveStr);
        }

        updateDisplay() {
            document.getElementById('timer').textContent = `Time: ${this.timeLeft}s`;
            document.getElementById('score').textContent = `Score: ${this.score}`;
        }

        endGame() {
            clearInterval(this.timer);
            alert(`Game Over! Your final score: ${this.score}`);
            // Reset board
            this.board.position('start');
        }
    }

    // Initialize the game when page loads
    document.addEventListener('DOMContentLoaded', () => {
        new PuzzleRacer();
    });
    </script>
</body>
</html>